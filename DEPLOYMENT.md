# Deployment Guide - Image Reconstruction App

Complete guide for deploying the Image Reconstruction application to a VPS using Docker.

---

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [VPS Setup](#vps-setup)
3. [Deployment Steps](#deployment-steps)
4. [Configuration](#configuration)
5. [SSL/HTTPS Setup (Optional)](#ssl-https-setup)
6. [Maintenance](#maintenance)
7. [Troubleshooting](#troubleshooting)

---

## Prerequisites

### On Your Local Machine:
- Git installed
- Access to your VPS via SSH

### On Your VPS:
- Ubuntu 20.04/22.04 or Debian 11/12 (recommended)
- Minimum 2GB RAM, 2 CPU cores
- At least 10GB free disk space
- Root or sudo access

---

## VPS Setup

### 1. Connect to Your VPS

```bash
ssh root@your-vps-ip
# or
ssh your-username@your-vps-ip
```

### 2. Update System

```bash
sudo apt update && sudo apt upgrade -y
```

### 3. Install Docker

```bash
# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Add your user to docker group (optional, to run docker without sudo)
sudo usermod -aG docker $USER

# Verify installation
docker --version
```

### 4. Install Docker Compose

```bash
# Download Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# Make it executable
sudo chmod +x /usr/local/bin/docker-compose

# Verify installation
docker-compose --version
```

---

## Deployment Steps

### 1. Clone Your Repository

```bash
# Create app directory
sudo mkdir -p /opt/image-reconstruction
sudo chown $USER:$USER /opt/image-reconstruction
cd /opt/image-reconstruction

# Clone the repository (replace with your repo URL)
git clone https://github.com/yourusername/image-reconstruction.git .

# Or upload files via SCP from your local machine:
# scp -r /path/to/image-reconstruction/* user@vps-ip:/opt/image-reconstruction/
```

### 2. Verify Model Files

```bash
# Ensure your model files are in place
ls -lh backend/model/
# Should show:
# - ConvNext_REAL-ESRGAN.pth
# - REAL-ESRGAN.pth
```

### 3. Create Data Directories

```bash
mkdir -p backend/data/uploads
mkdir -p backend/data/outputs
chmod 755 backend/data/uploads backend/data/outputs
```

### 4. Configure Environment (Optional)

Create a `.env` file for custom settings:

```bash
nano .env
```

Add your custom configuration:

```env
# Backend Configuration
BACKEND_HOST=0.0.0.0
BACKEND_PORT=8000
BACKEND_MODEL_DEVICE=cpu  # Change to 'cuda' if GPU available

# Upload Settings
BACKEND_UPLOAD_MAX_SIZE_MB=20

# Logging
LOGGING_LEVEL=INFO

# Frontend
FRONTEND_PORT=80
```

### 5. Build and Start Services

```bash
# Build and start in detached mode
docker-compose up -d --build

# View logs
docker-compose logs -f

# Check status
docker-compose ps
```

### 6. Verify Deployment

```bash
# Test backend API
curl http://localhost:8000/api/health

# Expected response:
# {"status":"ok","model_loaded":true,"device":"cpu"}

# Test frontend (from your browser)
# Open: http://your-vps-ip
```

---

## Configuration

### Update Backend Configuration

Edit `config.json`:

```bash
nano config.json
```

Key settings to adjust:

```json
{
  "backend": {
    "host": "0.0.0.0",
    "port": 8000,
    "upload": {
      "max_size_mb": 20  // Increase for larger images
    }
  },
  "frontend": {
    "backend_url": "http://your-domain.com",  // Update for production
    "polling": {
      "interval_ms": 800
    }
  }
}
```

Restart after changes:

```bash
docker-compose restart
```

### Firewall Configuration

```bash
# Allow HTTP
sudo ufw allow 80/tcp

# Allow HTTPS (if using SSL)
sudo ufw allow 443/tcp

# Allow SSH (if not already allowed)
sudo ufw allow 22/tcp

# Enable firewall
sudo ufw enable

# Check status
sudo ufw status
```

---

## SSL/HTTPS Setup (Optional but Recommended)

### Option 1: Using Certbot with Docker

1. **Install Certbot:**

```bash
sudo apt install certbot python3-certbot-nginx -y
```

2. **Update nginx.conf for SSL:**

Create `nginx-ssl.conf`:

```bash
nano nginx-ssl.conf
```

Add:

```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    # SSL certificates (will be generated by Certbot)
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Frontend
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # Backend API
    location /api/ {
        proxy_pass http://backend:8000/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        client_max_body_size 50M;
    }
}
```

3. **Update docker-compose.yml:**

```yaml
frontend:
  image: nginx:alpine
  ports:
    - "80:80"
    - "443:443"  # Add HTTPS port
  volumes:
    - ./frontend:/usr/share/nginx/html:ro
    - ./nginx-ssl.conf:/etc/nginx/conf.d/default.conf:ro
    - /etc/letsencrypt:/etc/letsencrypt:ro  # Mount SSL certs
```

4. **Generate SSL Certificate:**

```bash
# Stop nginx if running
docker-compose stop frontend

# Generate certificate
sudo certbot certonly --standalone -d your-domain.com -d www.your-domain.com

# Restart services
docker-compose up -d
```

5. **Auto-renewal:**

```bash
# Test renewal
sudo certbot renew --dry-run

# Certbot will auto-renew, but restart nginx after renewal
echo "0 0 1 * * docker-compose restart frontend" | sudo crontab -
```

---

## Maintenance

### View Logs

```bash
# All services
docker-compose logs -f

# Backend only
docker-compose logs -f backend

# Frontend only
docker-compose logs -f frontend

# Last 100 lines
docker-compose logs --tail=100
```

### Update Application

```bash
cd /opt/image-reconstruction

# Pull latest changes
git pull origin master

# Rebuild and restart
docker-compose up -d --build

# Or without downtime (if you have backups)
docker-compose build
docker-compose up -d --no-deps --build backend
docker-compose up -d --no-deps --build frontend
```

### Backup Data

```bash
# Backup uploads and outputs
tar -czf backup-$(date +%Y%m%d).tar.gz backend/data/

# Backup to remote server
scp backup-*.tar.gz user@backup-server:/backups/
```

### Clean Up Old Data

```bash
# Remove old upload files (older than 7 days)
find backend/data/uploads -type f -mtime +7 -delete
find backend/data/outputs -type f -mtime +7 -delete

# Clean Docker
docker system prune -a --volumes -f
```

### Monitor Resource Usage

```bash
# Container stats
docker stats

# Disk usage
df -h
du -sh backend/data/*

# Memory usage
free -h
```

---

## Troubleshooting

### Issue: Backend not starting

```bash
# Check logs
docker-compose logs backend

# Common fixes:
# 1. Model files missing
ls -lh backend/model/

# 2. Port conflict
sudo lsof -i :8000

# 3. Permission issues
sudo chown -R 1000:1000 backend/data/
```

### Issue: Frontend shows connection error

```bash
# Check if backend is running
curl http://localhost:8000/api/health

# Check nginx config
docker-compose exec frontend nginx -t

# Check browser console for CORS errors
# Update config.json backend_url to match your domain
```

### Issue: Large file upload fails

```bash
# Increase client_max_body_size in nginx.conf
# Update config.json max_size_mb

# Restart
docker-compose restart
```

### Issue: Out of disk space

```bash
# Check disk usage
df -h

# Clean old data
find backend/data/uploads -type f -mtime +7 -delete
find backend/data/outputs -type f -mtime +7 -delete

# Clean Docker
docker system prune -a --volumes
```

### Issue: Slow processing

```bash
# Check CPU/Memory
docker stats

# Consider:
# 1. Upgrade VPS resources
# 2. Use GPU if available (update BACKEND_MODEL_DEVICE=cuda)
# 3. Optimize model settings
```

---

## Production Checklist

- [ ] Domain name configured
- [ ] SSL certificate installed
- [ ] Firewall configured
- [ ] Automated backups setup
- [ ] Log rotation configured
- [ ] Monitoring setup (optional: Prometheus, Grafana)
- [ ] Update `config.json` with production settings
- [ ] Set strong passwords if adding authentication
- [ ] Configure error alerts (optional)
- [ ] Document custom configurations
- [ ] Test backup restoration process

---

## Quick Commands Reference

```bash
# Start services
docker-compose up -d

# Stop services
docker-compose down

# Restart services
docker-compose restart

# View logs
docker-compose logs -f

# Rebuild
docker-compose up -d --build

# Check status
docker-compose ps

# Access backend shell
docker-compose exec backend bash

# Access frontend shell
docker-compose exec frontend sh
```

---

## Support

For issues or questions:
1. Check logs: `docker-compose logs -f`
2. Review this guide
3. Check GitHub issues
4. Contact: your-email@domain.com

---

**ðŸŽ‰ Your Image Reconstruction app is now deployed and ready for production use!**
